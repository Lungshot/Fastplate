name: Claude Autonomous Development

on:
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      focus_area:
        description: 'Area to focus on (leave empty for auto-detect)'
        required: false
        default: ''
      max_iterations:
        description: 'Maximum development iterations'
        required: false
        default: '60'

  # Can also trigger on schedule (commented out - enable if desired)
  # schedule:
  #   - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  autonomous-development:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 50  # Get recent history for context

      - name: Run Claude Development Session
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are an autonomous development agent for the Fastplate project (a 3D nameplate generator using CadQuery, PyQt5, and PyQtGraph).

            ## Your Mission
            Review the current development status and continue making progress on the project.

            ## CRITICAL PRIORITY: Windows 11 Standalone EXE

            **THIS IS THE HIGHEST PRIORITY REQUIREMENT**

            The application MUST run on Windows 11 directly from the EXE with ZERO external dependencies.
            Users should NOT need to install Python, DLLs, Visual C++ Redistributables, or anything else.

            ### Verification Required:
            1. Review PyInstaller spec file and build process
            2. Ensure ALL dependencies are bundled:
               - CadQuery/OpenCASCADE libraries
               - casadi DLLs (must be in _internal/ root, not subfolder)
               - PyQt5 plugins and DLLs
               - PyQtGraph/OpenGL dependencies
               - Font files and preset JSON files
            3. Verify resource paths use sys._MEIPASS detection for frozen app
            4. Test that --onedir build includes everything needed

            Read TODO.md for the full requirements checklist.

            ## Step 1: Assess Current State
            1. Read TODO.md for full requirements and known issues
            2. Read the recent git commits: `git log --oneline -20`
            3. Review the PyInstaller spec file and build.bat
            4. Check src/utils/resources.py for frozen app path handling

            ## Step 2: Known Issues to Address (After Windows EXE verification)
            1. **Engraved/cutout text styles** - Preview still shows raised text above when engraved or cutout is selected
            2. **Built-in presets not loading** - Presets should appear in the presets panel
            3. **Mounting options error** - "Cannot find a solid on the stack" error
            4. **Default view options** - Should be: light grey color, Edge Highlight lighting, Grid on, Edges off, Wireframe off
            5. **Preset save/load** - Mixing up text lines and adding duplicates
            6. **Reset buttons** - Each setting needs a reset-to-default button
            7. **import SVG** - Add the ability to import SVG / vector path images and add them to the nameplate. After they are imported, the user should be able to position them in the viewport with the mouse and change rotation, axis, scaling etc.

            ## Step 3: Development Guidelines
            - Focus area (if specified): ${{ github.event.inputs.focus_area || 'auto-detect from TODO.md' }}
            - Make small, focused commits
            - Test changes where possible
            - Update documentation if needed
            - Create issues for bugs you discover but can't immediately fix

            ## Step 4: Create a Summary
            After making changes, create or update an issue summarizing:
            - What you accomplished
            - What issues remain
            - Recommended next steps
            - Status of Windows 11 standalone EXE readiness

            ## Constraints
            - Maximum iterations: ${{ github.event.inputs.max_iterations || '60' }}
            - Don't break existing functionality
            - Commit working code only
            - If stuck on an issue, document it and move to the next

            Begin your development session now.

          claude_args: |
            --max-turns 50
